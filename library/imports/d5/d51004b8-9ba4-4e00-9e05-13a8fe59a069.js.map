{"version":3,"sources":["../../../../../assets/src/role/assets/src/role/panda-control.js"],"names":["cc","Class","extends","Component","properties","speed","v2","addSpeed","maxSpeed","gravity","jumpSpeed","collisionX","collisionY","direction","jumping","jumpCount","drag","prePosition","player","uiLayer","Node","uiLayerComonent","onLoad","x","node","y","manager","director","getCollisionManager","enabled","getComponent","Animation","eventManager","addListener","event","EventListener","KEYBOARD","onKeyPressed","bind","onKeyReleased","onDestroy","onDisabled","enabledDebugDraw","keyCode","KEY","d","play","a","j","collisionGoldEnter","other","self","removeFromParent","addGold","collisionPlatformEnter","selfAabb","world","aabb","clone","otherAabb","preAabb","Intersection","rectRect","xMax","xMin","width","yMax","yMin","height","onCollisionEnter","console","log","tag","onCollisionStay","offset","onCollisionExit","update","dt","Math","abs","trueDir"],"mappings":"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","file":"panda-control.js","sourceRoot":"../../../../../assets/src/role","sourcesContent":["\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        speed:cc.v2(0, 0),\n        addSpeed: 600,\n        maxSpeed: cc.v2(10, 1000),\n        gravity: -1000,\n        jumpSpeed: 300,\n        collisionX: 0,\n        collisionY: 0,\n        direction: 0, //控制的方向，只有左右\n        jumping: false,\n        jumpCount: 0, //跳跃次数\n        drag: 1000,\n        prePosition:cc.v2(0,0), //上一帧的坐标\n        player: null, // 动画播放器\n\n        // //外部组件\n        uiLayer: cc.Node,\n        uiLayerComonent: null,\n    },\n\n    // use this for initialization\n    onLoad: function () {\n       this.prePosition.x = this.node.x;\n       this.prePosition.y = this.node.y;\n\n       var manager = cc.director.getCollisionManager();\n       manager.enabled = true;\n    //    manager.enabledDebugDraw = true;\n\n        this.player = this.node.getComponent(cc.Animation);\n\n        //UI组件\n        this.uiLayerComonent = this.uiLayer.getComponent(\"uiLayer\");\n\n       cc.eventManager.addListener({\n            event: cc.EventListener.KEYBOARD,\n            onKeyPressed: this.onKeyPressed.bind(this),\n            onKeyReleased: this.onKeyReleased.bind(this)\n        }, this.node);\n    },\n\n    onDestroy: function onDisabled() {\n        cc.director.getCollisionManager().enabled = false;\n        cc.director.getCollisionManager().enabledDebugDraw = false;\n    },\n\n    onKeyPressed: function (keyCode, event) {\n        switch (keyCode) {\n            case cc.KEY.d:\n                this.direction = 1;\n\n                if (!this.jumping) this.player.play(\"run\");    \n                break;\n            case cc.KEY.a:\n                this.direction = -1;\n                if (!this.jumping) this.player.play(\"run\");   \n\n                break;\n            case cc.KEY.j:\n                if (!this.jumping || this.jumpCount < 2) {\n                    this.jumping = true;\n                    this.speed.y = this.jumpSpeed;\n\n                    this.jumpCount++;\n                    this.jumpCount < 2 ? this.player.play(\"jump\") : this.player.play(\"twiceJump\");\n                }\n                break;\n        }\n    },\n\n    onKeyReleased: function (keyCode, event) {\n         switch (keyCode) {\n            case cc.KEY.d:\n                if (this.direction == 1) {\n                    this.direction = 0;\n                }\n                break;\n            case cc.KEY.a:\n                if (this.direction == -1) {\n                    this.direction = 0;\n                }\n                break;\n         }\n    },\n\n    collisionGoldEnter: function (other, self) {\n        other.node.removeFromParent();\n\n        this.uiLayerComonent.addGold();\n    },\n    \n\n    collisionPlatformEnter: function (other, self) {\n        var selfAabb = self.world.aabb.clone();\n        var otherAabb = other.world.aabb;\n        var preAabb = self.world.preAabb;\n\n        selfAabb.x = preAabb.x;\n        selfAabb.y = preAabb.y;\n\n        //检查X是否发生碰撞\n        selfAabb.x = self.world.aabb.x;\n        if (cc.Intersection.rectRect(selfAabb, otherAabb)) {\n            if (this.speed.x < 0 && selfAabb.xMax > otherAabb.xMax) {\n                this.node.x = otherAabb.xMax;\n                this.collisionX = -1;\n            } else if (this.speed.x > 0 && selfAabb.xMin < otherAabb.xMin) {\n                this.node.x = otherAabb.xMin - selfAabb.width;\n                this.collisionX = 1;\n            }\n\n            this.speed.x = 0;\n            return;\n        }\n\n        //检查Y是否发生碰撞\n        selfAabb.y = self.world.aabb.y;\n        if (cc.Intersection.rectRect(selfAabb, otherAabb)) {\n            if (this.speed.y < 0 && selfAabb.yMax > otherAabb.yMax) {\n                this.node.y = otherAabb.yMax;\n                this.jumping = false;\n                this.player.play(\"run\");\n                this.jumpCount = 0;\n                this.collisionY = -1;\n            } else if (this.speed.y > 0 && selfAabb.yMin < otherAabb.yMin) {\n                this.node.y = otherAabb.yMin - selfAabb.height;\n                this.collisionY = 1;\n            }\n\n            this.speed.y = 0;\n        }\n    },\n\n    onCollisionEnter: function (other, self) {\n        console.log('on collision enter');\n        cc.log(\"coll tag = \" + other.tag);\n\n       if (other.tag == 1) {\n           this.collisionGoldEnter(other, self);\n       }\n       else{\n           this.collisionPlatformEnter(other, self);\n       }\n    },\n\n    onCollisionStay: function (other, self) {\n        // console.log('on collision stay');\n\n        if (other.tag != 0) return;\n        if (this.collisionY === -1) {\n            var offset = cc.v2(other.world.aabb.x - other.world.preAabb.x, 0);\n\n            // var temp = cc.affineTransformClone(self.world.transform);\n            // temp.tx = temp.ty = 0;\n\n            // offset = cc.pointApplyAffineTransform(offset, temp);\n            this.node.x += offset.x;\n        }\n    },\n    \n    /**\n     * 当碰撞结束后调用\n     * @param  {Collider} other 产生碰撞的另一个碰撞组件\n     * @param  {Collider} self  产生碰撞的自身的碰撞组件\n     */\n    onCollisionExit: function (other, self) {\n        console.log('on collision exit');\n        if (other.tag != 0) return;\n        \n        this.collisionX = 0;\n        this.collisionY = 0;\n        this.jumping = true;\n        this.jumpCount = 1;\n        this.player.play(\"jump\");\n    },\n    \n    // called every frame, uncomment this function to activate update callback\n    update: function (dt) {\n        /**\n         * Y轴变化\n         *  */ \n        if (this.collisionY === 0) //没任何碰撞，计算重力\n        {\n            this.speed.y += this.gravity * dt;\n            if (Math.abs(this.speed.y) > this.maxSpeed.y) \n            {\n                this.speed.y = this.speed.y > 0 ? this.maxSpeed.y : -this.maxSpeed.y;\n            }\n        } \n\n        if (this.direction === 0) {\n            //停下的时候，计算摩擦力 \n            if (this.speed.x > 0) {\n                this.speed.x -= this.drag * dt;\n                if (this.speed.x <= 0) this.speed.x = 0;\n            } else if (this.speed.x < 0) {\n                this.speed.x += this.drag * dt;\n                if (this.speed.x >= 0) this.speed.x = 0;\n            }\n        } else {\n            //左右速度行走,如果反方向，速度用更大的摩擦力，令方向更快改变\n            var trueDir = this.speed.x > 0 ? 1 : -1;\n            if (this.speed.x == 0) trueDir = 0;\n            var speed = (trueDir == this.direction ? this.addSpeed : 3000);\n\n            this.speed.x += (this.direction > 0 ? 1 : -1) * speed * dt;\n            if (Math.abs(this.speed.x) > this.maxSpeed.x) {\n                this.speed.x = this.speed.x > 0 ? this.maxSpeed.x : -this.maxSpeed.x;\n            }\n        }\n\n        //左右有碰撞,X立刻停下\n        if (this.speed.x * this.collisionX > 0) {\n            this.speed.x = 0;\n        }\n\n        this.prePosition.x = this.node.x;\n        this.prePosition.y = this.node.y;\n\n        this.node.x += this.speed.x * dt;\n        this.node.y += this.speed.y * dt;\n    },\n});\n"]}